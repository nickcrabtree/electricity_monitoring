# Quick Start: Kasa Monitoring with DHCP Devices\n\nSince Kasa devices use DHCP and get dynamic IPs, configure them using **hostname** or **MAC address** instead.\n\n## 5-Minute Setup\n\n### 1. Find Your Devices\n\n**Option A: SSH to OpenWrt (fastest)**\n```bash\nssh root@192.168.86.1\ncat /var/dhcp.leases\n```\n\nLook for Kasa devices:\n```\n1635593400 84:0d:8e:aa:bb:01 Smart-Plug-Living 192.168.86.50 1635593600\n1635593400 84:0d:8e:aa:bb:02 Smart-Plug-Kitchen 192.168.86.51 1635593600\n```\n\n**Option B: From your machine**\n```bash\narp -a | grep -i kasa\n```\n\n### 2. Choose Identification Method\n\n| Method | Example | When to Use |\n|--------|---------|-------------|\n| **Hostname** | `Smart-Plug-Living.local` | Recommended - human-readable |\n| **MAC** | `84:0D:8E:AA:BB:01` | Failsafe - works everywhere |\n| **IP** | `192.168.86.50` | ❌ Not recommended - DHCP |\n\n### 3. Configure Devices\n\nEdit `config.py`:\n\n```python\nKASA_DEVICES = {\n    'Smart-Plug-Living.local': 'living_room_plug',\n    'Smart-Plug-Kitchen.local': 'kitchen_plug',\n    # Or using MAC addresses:\n    # '84:0D:8E:AA:BB:01': 'living_room_plug',\n    # '84:0D:8E:AA:BB:02': 'kitchen_plug',\n}\n```\n\n### 4. Test\n\n```bash\ncd /home/nickc/code/electricity_monitoring\nconda activate electricity\n\n# Test discovery\npython kasa_to_graphite.py --discover\n\n# Test single poll\npython kasa_to_graphite.py --once\n\n# Run continuously\npython kasa_to_graphite.py &\n```\n\n## How It Works\n\nThe script automatically:\n1. **Resolves** hostname/MAC to current IP\n2. **Connects** to the device\n3. **Polls** power metrics\n4. **Sends** to Graphite\n5. **Repeats** every 30 seconds\n\nIf the device's IP changes (DHCP renewal):\n- Script re-resolves the hostname/MAC\n- Gets new IP automatically\n- Continues monitoring seamlessly\n\n## Hostname vs MAC Address\n\n### Hostnames (Preferred)\n```python\nKASA_DEVICES = {\n    'Smart-Plug-Living.local': 'living_room_plug',\n}\n```\n\n✅ **Pros:**\n- Easy to read and remember\n- Works with mDNS (.local)\n- Human-friendly\n\n❌ **Cons:**\n- Requires mDNS to resolve\n- May not work on all networks\n\n### MAC Addresses (Failsafe)\n```python\nKASA_DEVICES = {\n    '84:0D:8E:AA:BB:01': 'living_room_plug',\n}\n```\n\n✅ **Pros:**\n- Works anywhere (no DNS)\n- Hardware identifier - never changes\n- Most reliable\n\n❌ **Cons:**\n- Requires ARP lookup\n- Less memorable\n\n## Troubleshooting\n\n### Devices not discovered\n\n```bash\n# Check if device is on network\nping Smart-Plug-Living.local\n\n# Or try MAC resolution\narp -a | grep -i \"84:0d:8e\"\n\n# Check Graphite is reachable\nnc -zv 192.168.86.123 2003\n```\n\n### Hostname not resolving\n\n```bash\n# Try .local domain\nping device-name.local\n\n# If that fails, use MAC address instead\n# Get MAC from: arp -a or OpenWrt DHCP leases\n```\n\n## Example Full Configuration\n\n```python\n# config.py\nKASA_DEVICES = {\n    # Living room plug with hostname\n    'Smart-Plug-LivingRoom.local': 'living_room_plug',\n    \n    # Kitchen plug with MAC (in case hostname fails)\n    '84:0D:8E:AA:BB:02': 'kitchen_plug',\n    \n    # Bedroom plug using static hostname\n    'bedroom-kasa.local': 'bedroom_plug',\n}\n```\n\n## Checking Metrics\n\nOnce running, verify data in Graphite:\n\n```bash\n# List all electricity metrics\ncurl -s 'http://192.168.86.123/metrics/find?query=home.electricity.*' | head\n\n# Get power readings for last 5 minutes\ncurl -s 'http://192.168.86.123/render?target=home.electricity.kasa.*.power_watts&from=-5min&format=json'\n```\n\n## Next Steps\n\n1. ✅ Find your devices (SSH to router)\n2. ✅ Update `config.py`\n3. ✅ Test with `--discover` and `--once`\n4. ✅ Run continuously: `python kasa_to_graphite.py`\n5. ✅ Check Graphite for metrics\n6. ✅ Set up as systemd service or cron\n\nSee `DEVICE_IDENTIFICATION.md` for detailed device lookup instructions.\n"}